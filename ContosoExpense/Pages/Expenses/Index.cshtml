@page
@model ContosoExpense.Pages.Expenses.IndexModel
@{
    ViewData["Title"] = "Expenses";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-receipt me-2"></i>Expenses</h2>
    <a asp-page="Create" class="btn btn-primary">
        <i class="bi bi-plus-circle me-1"></i>New Expense
    </a>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Search</label>
                <input type="text" class="form-control" name="SearchTerm" value="@Model.Filter.SearchTerm" 
                       placeholder="Title or description..." aria-label="Search expenses">
            </div>
            <div class="col-md-2">
                <label class="form-label">Status</label>
                <select class="form-select" name="Status" aria-label="Filter by status">
                    <option value="">All</option>
                    @foreach (var status in Enum.GetValues<ExpenseStatus>())
                    {
                        <option value="@status" selected="@(Model.Filter.Status == status)">@status</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Category</label>
                <select class="form-select" name="CategoryId" aria-label="Filter by category">
                    <option value="">All</option>
                    @foreach (var category in Model.Categories)
                    {
                        <option value="@category.Id" selected="@(Model.Filter.CategoryId == category.Id)">@category.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">From Date</label>
                <input type="date" class="form-control" name="DateFrom" value="@Model.Filter.DateFrom?.ToString("yyyy-MM-dd")" aria-label="From date">
            </div>
            <div class="col-md-2">
                <label class="form-label">To Date</label>
                <input type="date" class="form-control" name="DateTo" value="@Model.Filter.DateTo?.ToString("yyyy-MM-dd")" aria-label="To date">
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-outline-primary w-100" aria-label="Apply filters">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Results -->
@if (Model.Expenses.Items.Count == 0)
{
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle me-2"></i>No expenses found. 
        <a asp-page="Create">Create your first expense</a>
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover" aria-label="Expenses list">
            <thead class="table-light">
                <tr>
                    <th scope="col">
                        <a href="?SortBy=ExpenseDate&SortDescending=@(!Model.Filter.SortDescending)&@Model.GetQueryString("SortBy", "SortDescending")" 
                           class="text-decoration-none text-dark">
                            Date @(Model.Filter.SortBy == "ExpenseDate" ? (Model.Filter.SortDescending ? "↓" : "↑") : "")
                        </a>
                    </th>
                    <th scope="col">
                        <a href="?SortBy=Title&SortDescending=@(!Model.Filter.SortDescending)&@Model.GetQueryString("SortBy", "SortDescending")" 
                           class="text-decoration-none text-dark">
                            Title @(Model.Filter.SortBy == "Title" ? (Model.Filter.SortDescending ? "↓" : "↑") : "")
                        </a>
                    </th>
                    <th scope="col">Category</th>
                    <th scope="col">
                        <a href="?SortBy=Amount&SortDescending=@(!Model.Filter.SortDescending)&@Model.GetQueryString("SortBy", "SortDescending")" 
                           class="text-decoration-none text-dark">
                            Amount @(Model.Filter.SortBy == "Amount" ? (Model.Filter.SortDescending ? "↓" : "↑") : "")
                        </a>
                    </th>
                    <th scope="col">Status</th>
                    @if (Model.IsManager)
                    {
                        <th scope="col">Submitted By</th>
                    }
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var expense in Model.Expenses.Items)
                {
                    <tr>
                        <td>@expense.ExpenseDate.ToString("MMM dd, yyyy")</td>
                        <td>
                            <a asp-page="Details" asp-route-id="@expense.Id" class="text-decoration-none">
                                @expense.Title
                            </a>
                        </td>
                        <td>
                            <i class="@expense.CategoryIcon category-icon"></i>@expense.CategoryName
                        </td>
                        <td>@expense.Amount.ToString("C") @expense.Currency</td>
                        <td>
                            <span class="badge status-@expense.Status.ToString().ToLower()">
                                @expense.Status
                            </span>
                        </td>
                        @if (Model.IsManager)
                        {
                            <td>@expense.UserDisplayName</td>
                        }
                        <td>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Expense actions">
                                <a asp-page="Details" asp-route-id="@expense.Id" class="btn btn-outline-secondary" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                @if (expense.CanEdit)
                                {
                                    <a asp-page="Edit" asp-route-id="@expense.Id" class="btn btn-outline-primary" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                }
                                @if (expense.CanSubmit)
                                {
                                    <form method="post" asp-page-handler="Submit" asp-route-id="@expense.Id" class="d-inline">
                                        <button type="submit" class="btn btn-outline-success" title="Submit for Approval">
                                            <i class="bi bi-send"></i>
                                        </button>
                                    </form>
                                }
                                @if (expense.CanApprove)
                                {
                                    <button type="button" class="btn btn-outline-success" title="Approve"
                                            data-bs-toggle="modal" data-bs-target="#approveModal" 
                                            data-expense-id="@expense.Id" data-expense-title="@expense.Title">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                }
                                @if (expense.CanReject)
                                {
                                    <button type="button" class="btn btn-outline-danger" title="Reject"
                                            data-bs-toggle="modal" data-bs-target="#rejectModal"
                                            data-expense-id="@expense.Id" data-expense-title="@expense.Title">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                }
                                @if (expense.CanPay)
                                {
                                    <form method="post" asp-page-handler="Pay" asp-route-id="@expense.Id" class="d-inline">
                                        <button type="submit" class="btn btn-outline-info" title="Mark as Paid">
                                            <i class="bi bi-cash"></i>
                                        </button>
                                    </form>
                                }
                                @if (expense.CanDelete)
                                {
                                    <form method="post" asp-page-handler="Delete" asp-route-id="@expense.Id" class="d-inline"
                                          onsubmit="return confirm('Are you sure you want to delete this expense?')">
                                        <button type="submit" class="btn btn-outline-danger" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    @if (Model.Expenses.TotalPages > 1)
    {
        <nav aria-label="Expense list pagination">
            <ul class="pagination justify-content-center">
                <li class="page-item @(Model.Expenses.HasPreviousPage ? "" : "disabled")">
                    <a class="page-link" href="?Page=@(Model.Expenses.Page - 1)&@Model.GetQueryString("Page")">Previous</a>
                </li>
                @for (int i = 1; i <= Model.Expenses.TotalPages; i++)
                {
                    <li class="page-item @(i == Model.Expenses.Page ? "active" : "")">
                        <a class="page-link" href="?Page=@i&@Model.GetQueryString("Page")">@i</a>
                    </li>
                }
                <li class="page-item @(Model.Expenses.HasNextPage ? "" : "disabled")">
                    <a class="page-link" href="?Page=@(Model.Expenses.Page + 1)&@Model.GetQueryString("Page")">Next</a>
                </li>
            </ul>
        </nav>
    }

    <p class="text-muted text-center">
        Showing @((Model.Expenses.Page - 1) * Model.Expenses.PageSize + 1) - 
        @Math.Min(Model.Expenses.Page * Model.Expenses.PageSize, Model.Expenses.TotalCount) 
        of @Model.Expenses.TotalCount expenses
    </p>
}

<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="Approve">
                <div class="modal-header">
                    <h5 class="modal-title" id="approveModalLabel">Approve Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="expenseId" id="approveExpenseId" />
                    <p>Approve expense: <strong id="approveExpenseTitle"></strong></p>
                    <div class="mb-3">
                        <label for="approvalNotes" class="form-label">Notes (optional)</label>
                        <textarea class="form-control" id="approvalNotes" name="notes" rows="3" 
                                  placeholder="Add any approval notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg me-1"></i>Approve
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="Reject">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectModalLabel">Reject Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="expenseId" id="rejectExpenseId" />
                    <p>Reject expense: <strong id="rejectExpenseTitle"></strong></p>
                    <div class="mb-3">
                        <label for="rejectionReason" class="form-label">Reason <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="rejectionReason" name="reason" rows="3" 
                                  placeholder="Provide a reason for rejection..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-x-lg me-1"></i>Reject
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Handle modal data passing
    document.getElementById('approveModal')?.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        document.getElementById('approveExpenseId').value = button.getAttribute('data-expense-id');
        document.getElementById('approveExpenseTitle').textContent = button.getAttribute('data-expense-title');
    });

    document.getElementById('rejectModal')?.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        document.getElementById('rejectExpenseId').value = button.getAttribute('data-expense-id');
        document.getElementById('rejectExpenseTitle').textContent = button.getAttribute('data-expense-title');
    });
</script>
}
